<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ultimate AI Planner - TKB Thông Minh</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3498db; --bg: #f4f6f8; --text: #2c3e50;
            --table-bg: white; --header: #2c3e50; --border: #dfe6e9;
        }
        body.dark-mode {
            --bg: #121212; --text: #ecf0f1; --table-bg: #1e1e1e;
            --header: #000; --border: #333;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; transition: 0.3s;
        }

        /* NÚT QUAY LẠI HOME - ĐÃ ĐỒNG BỘ MÀU */
        .back-home {
            position: fixed; 
            top: 13px; 
            left: 15px; 
            background: var(--primary); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 6px; 
            text-decoration: none; 
            z-index: 9999;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-home:hover {
            opacity: 0.9;
            transform: translateX(-3px);
        }

        /* BANNER THÔNG BÁO ĐẾM NGƯỢC */
        #countdown-banner {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            color: white; padding: 10px; text-align: center;
            font-weight: bold; display: none; /* Hiện khi có tiết */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .top-bar { 
            background: var(--header); 
            color: white; 
            padding: 12px 25px 12px 140px; /* Thêm padding trái để không đè lên nút Home */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        
        .main-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; padding: 20px; max-width: 1400px; margin: auto; }

        /* BẢNG & THỐNG KÊ */
        .card { background: var(--table-bg); border-radius: 12px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; border: 1px solid var(--border); text-align: center; }
        th { background: var(--header); color: white; }

        .current-lesson { 
            outline: 4px solid #e74c3c !important; 
            animation: pulse 2s infinite; font-weight: bold;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); } 70% { box-shadow: 0 0 0 10px rgba(231,76,60,0); } 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); } }

        /* ANALYTICS CHIPS */
        .stats-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .stat-chip { background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; }

        /* TO-DO LIST */
        .todo-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .todo-item.done span { text-decoration: line-through; opacity: 0.5; }

        /* BUTTONS */
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-primary { background: var(--primary); color: white; }
        
        .delete-btn { position: absolute; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; display: none; }
        body.edit-mode .delete-btn { display: flex; align-items: center; justify-content: center; }
        .del-col { top: -11px; right: 50%; transform: translateX(50%); }
        .del-row { left: -11px; top: 50%; transform: translateY(-50%); }

        @media print { .top-bar, #countdown-banner, .todo-section, .toolbar, .back-home, .delete-btn { display: none !important; } }
    </style>
</head>
<body>

    <a href="../bộ home/dashboard.html" class="back-home">
        &larr; Quay lại Home
    </a>

    <div id="countdown-banner">
        <i class="fas fa-stopwatch"></i> <span id="countdown-text">Đang tải...</span>
    </div>

    <div class="top-bar">
        <div style="font-size: 22px; font-weight: 900;"><i class="fas fa-brain"></i> AI PLANNER</div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="requestNotify()"><i class="fas fa-bell"></i> Thông báo</button>
            <button class="btn btn-dark" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
            <select id="schSelect" onchange="switchSch()" style="padding:8px; border-radius:8px;"></select>
        </div>
    </div>

    <div class="main-layout">
        <div class="table-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="schTitle" contenteditable="true" onblur="saveTitle()">Thời Khóa Biểu</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="toggleEdit()"><i class="fas fa-edit"></i> Chỉnh sửa</button>
                        <button class="btn btn-success" onclick="addRow()">+ Hàng</button>
                        <button class="btn btn-success" onclick="addCol()">+ Cột</button>
                    </div>
                </div>

                <div style="margin: 15px 0; display:flex; align-items:center; gap:15px;">
                    <span>Màu tô nhanh:</span>
                    <input type="color" id="colorInput" value="#3498db">
                </div>

                <table id="mainTable">
                    <thead id="tHead"></thead>
                    <tbody id="tBody"></tbody>
                </table>

                <h3 style="margin-top: 30px;"><i class="fas fa-chart-pie"></i> Thống kê tiết học/tuần</h3>
                <div id="statsBox" class="stats-container"></div>
            </div>
        </div>

        <div class="todo-section">
            <div class="card" style="margin-bottom: 20px;">
                <h3><i class="fas fa-check-double"></i> Việc cần làm</h3>
                <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                    <input type="text" id="todoIn" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ddd;" placeholder="Việc mới...">
                    <button class="btn btn-success" onclick="addTodo()">+</button>
                </div>
                <div id="todoList"></div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> Hướng dẫn</h3>
                <p style="font-size: 13px; color: #7f8c8d;">- Cột giờ nhập dạng: <b>08:00-08:45</b> để đếm ngược.<br>- Tắt 'Chỉnh sửa' để tô màu nhanh.</p>
            </div>
        </div>
    </div>

    <script>
        let isEdit = false;
        let appData = {
            schedules: [{ title: "Lịch Học Kỳ 1", headers: ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6"], 
            rows: [{ time: "07:30-08:15", cells: Array(5).fill({t: "Toán", c: "#e3f2fd"}) }], todos: [] }],
            currIdx: 0, dark: false
        };

        function init() {
            const saved = localStorage.getItem('ai_planner_v1');
            if (saved) appData = JSON.parse(saved);
            render();
            setInterval(updateRealtime, 1000); // Đếm ngược mỗi giây
        }

        function render() {
            document.body.classList.toggle('dark-mode', appData.dark);
            const sch = appData.schedules[appData.currIdx];
            
            // Render Select & Title
            document.getElementById('schSelect').innerHTML = appData.schedules.map((s,i)=>`<option value="${i}" ${i==appData.currIdx?'selected':''}>${s.title}</option>`).join('');
            document.getElementById('schTitle').innerText = sch.title;

            // Render Table
            document.getElementById('tHead').innerHTML = `<tr><th>Tiết</th><th>Thời gian</th>${sch.headers.map((h,i)=>`<th><span contenteditable="${isEdit}" onblur="editH(${i},this)">${h}</span><button class="delete-btn del-col" onclick="delCol(${i})">×</button></th>`).join('')}</tr>`;
            document.getElementById('tBody').innerHTML = sch.rows.map((r, rI)=>`<tr>
                <td class="col-fixed">${rI+1}<button class="delete-btn del-row" onclick="delRow(${rI})">×</button></td>
                <td contenteditable="${isEdit}" onblur="editTime(${rI},this)">${r.time}</td>
                ${r.cells.map((c, cI)=>`<td contenteditable="${isEdit}" style="background:${c.c};color:${getContrast(c.c)}" onclick="clickCell(this,${rI},${cI})" oninput="editCell(${rI},${cI},this)">${c.t}</td>`).join('')}
            </tr>`).join('');

            renderTodos();
            updateStats();
        }

        /* TÍNH NĂNG 1: ĐẾM NGƯỢC & THÔNG BÁO */
        function updateRealtime() {
            const now = new Date();
            const curMin = now.getHours() * 60 + now.getMinutes();
            const curDay = now.getDay(); // 1=T2, 6=T7
            const banner = document.getElementById('countdown-banner');
            const text = document.getElementById('countdown-text');
            
            let activeLesson = null;
            const sch = appData.schedules[appData.currIdx];

            if (curDay >= 1 && curDay <= 6) {
                sch.rows.forEach((row, rI) => {
                    const times = row.time.split('-');
                    if (times.length === 2) {
                        const start = timeToMin(times[0]), end = timeToMin(times[1]);
                        if (curMin >= start && curMin < end) {
                            const left = end - curMin;
                            const subject = row.cells[curDay-1].t;
                            activeLesson = { subject, left, rI, cI: curDay+1 };
                        }
                    }
                });
            }

            // Cập nhật giao diện đếm ngược
            if (activeLesson) {
                banner.style.display = 'block';
                text.innerText = `ĐANG TRONG TIẾT: ${activeLesson.subject.toUpperCase()} (Còn ${activeLesson.left} phút nữa kết thúc)`;
                // Highlight ô
                document.querySelectorAll('td').forEach(td => td.classList.remove('current-lesson'));
                document.getElementById('tBody').rows[activeLesson.rI].cells[activeLesson.cI].classList.add('current-lesson');
            } else {
                banner.style.display = 'none';
                document.querySelectorAll('td').forEach(td => td.classList.remove('current-lesson'));
            }
        }

        function updateStats() {
            const sch = appData.schedules[appData.currIdx];
            const counts = {};
            sch.rows.forEach(r => r.cells.forEach(c => {
                const name = c.t.trim();
                if(name && name !== "...") counts[name] = (counts[name] || 0) + 1;
            }));

            document.getElementById('statsBox').innerHTML = Object.entries(counts)
                .map(([name, count]) => `<div class="stat-chip">${name}: ${count} tiết</div>`).join('');
        }

        function requestNotify() {
            Notification.requestPermission().then(p => { if(p === 'granted') alert("Đã bật thông báo thành công!"); });
        }

        function timeToMin(s) { const [h, m] = s.split(':').map(Number); return h * 60 + m; }
        function clickCell(td, r, c) { if(!isEdit) { const color = document.getElementById('colorInput').value; appData.schedules[appData.currIdx].rows[r].cells[c].c = color; td.style.background = color; td.style.color = getContrast(color); save(); updateStats(); } }
        function toggleEdit() { isEdit = !isEdit; document.body.classList.toggle('edit-mode', isEdit); render(); }
        function save() { localStorage.setItem('ai_planner_v1', JSON.stringify(appData)); }
        function editCell(r, c, td) { appData.schedules[appData.currIdx].rows[r].cells[c].t = td.innerText; save(); updateStats(); }
        function editTime(r, td) { appData.schedules[appData.currIdx].rows[r].time = td.innerText; save(); }
        function editH(i, td) { appData.schedules[appData.currIdx].headers[i] = td.innerText; save(); }
        function saveTitle() { appData.schedules[appData.currentIdx].title = document.getElementById('schTitle').innerText; save(); }
        function addRow() { const sch = appData.schedules[appData.currIdx]; sch.rows.push({time:"07:00-07:45", cells: Array(sch.headers.length).fill({t:"...", c:"#fff"})}); save(); render(); }
        function addCol() { const sch = appData.schedules[appData.currIdx]; sch.headers.push("Thứ mới"); sch.rows.forEach(r => r.cells.push({t:"...", c:"#fff"})); save(); render(); }
        function delRow(i) { if(confirm("Xóa hàng?")) { appData.schedules[appData.currIdx].rows.splice(i,1); save(); render(); } }
        function delCol(i) { if(confirm("Xóa cột?")) { const sch = appData.schedules[appData.currIdx]; sch.headers.splice(i,1); sch.rows.forEach(r => r.cells.splice(i,1)); save(); render(); } }
        function toggleDarkMode() { appData.dark = !appData.dark; save(); render(); }
        function renderTodos() { 
            const sch = appData.schedules[appData.currIdx];
            document.getElementById('todoList').innerHTML = (sch.todos || []).map((t, i) => `
                <div class="todo-item ${t.done?'done':''}">
                    <input type="checkbox" ${t.done?'checked':''} onclick="toggleTodo(${i})">
                    <span style="flex:1">${t.text}</span>
                    <i class="fas fa-trash" onclick="delTodo(${i})" style="color:#e74c3c; cursor:pointer"></i>
                </div>`).join('');
        }
        function addTodo() { const inp = document.getElementById('todoIn'); if(inp.value) { appData.schedules[appData.currIdx].todos.push({text:inp.value, done:false}); inp.value=""; save(); renderTodos(); } }
        function toggleTodo(i) { appData.schedules[appData.currIdx].todos[i].done = !appData.schedules[appData.currIdx].todos[i].done; save(); renderTodos(); }
        function delTodo(i) { appData.schedules[appData.currIdx].todos.splice(i,1); save(); renderTodos(); }
        function getContrast(hex) { if(!hex || hex[0]!='#') return 'black'; const r=parseInt(hex.substr(1,2),16), g=parseInt(hex.substr(3,2),16), b=parseInt(hex.substr(5,2),16); return ((r*299)+(g*587)+(b*114))/1000 >= 128 ? 'black' : 'white'; }
        
        init();
    </script>
</body>
</html>